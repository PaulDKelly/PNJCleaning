{% extends "base.html" %}

{% block title %}Manager Diary - PNJ Extraction Services{% endblock %}

{% block content %}
<div class="flex flex-col gap-8 pb-32">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <div class="text-[10px] uppercase tracking-[0.3em] font-bold text-slate-400 mb-1">Operations / Job Queue
            </div>
            <h2 class="text-3xl font-bold text-slate-800 font-outfit">Management Diary</h2>
            <p class="text-slate-500">Coordinate engineer schedules and track job progress.</p>
        </div>
        <div class="flex gap-2">
            <a href="/job-allocation" class="btn btn-primary shadow-lg shadow-primary/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Allocate New Job
            </a>
        </div>
    </div>

    <!-- Tabs Container -->
    <div role="tablist" class="tabs tabs-lifted tabs-lg">

        <!-- Tab 1: Live Jobs -->
        <input type="radio" name="diary_tabs" role="tab" class="tab font-bold" aria-label="Live Jobs" checked />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">

            <!-- Live Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stats shadow-sm border border-slate-100">
                    <div class="stat">
                        <div class="stat-title text-xs uppercase tracking-widest font-bold text-slate-500">In Progress
                        </div>
                        <div class="stat-value text-2xl text-info font-outfit">{{ jobs|selectattr('status', 'equalto',
                            'In Progress')|list|length }}</div>
                    </div>
                </div>
                <div class="stats shadow-sm border border-slate-100">
                    <div class="stat">
                        <div class="stat-title text-xs uppercase tracking-widest font-bold text-slate-500">Scheduled
                        </div>
                        <div class="stat-value text-2xl text-warning font-outfit">{{ jobs|selectattr('status',
                            'equalto', 'Scheduled')|list|length }}</div>
                    </div>
                </div>
                <div class="stats shadow-sm border border-slate-100">
                    <div class="stat">
                        <div class="stat-title text-xs uppercase tracking-widest font-bold text-slate-500">Submitted
                            Reports</div>
                        <div class="stat-value text-2xl text-indigo-600 font-outfit">{{ jobs|selectattr('status',
                            'equalto', 'Submitted')|list|length }}</div>
                    </div>
                </div>
            </div>

            <!-- Live Table -->
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full shadow-sm rounded-xl overflow-hidden">
                    <thead class="bg-slate-50 uppercase text-[10px] text-slate-500 font-black">
                        <tr>
                            <th class="p-4">Schedule</th>
                            <th>Identity</th>
                            <th>Customer & Site</th>
                            <th>Team</th>
                            <th>Workflow Status</th>
                            <th class="text-right whitespace-nowrap">Admin Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs if job.status != 'Archived' %}
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="p-4">
                                <div class="font-bold text-slate-700">{{ job.date.strftime('%d %b %Y') }}</div>
                                <div class="text-[10px] text-slate-400 uppercase font-black tracking-tighter">{{
                                    job.time.strftime('%H:%M') }}</div>
                            </td>
                            <td>
                                <div class="badge badge-primary font-mono text-[10px] mb-1 uppercase tracking-tighter">
                                    {{ job.job_number }}</div>
                                <div class="block">
                                    <span
                                        class="badge badge-xs font-black uppercase text-[8px]
                                        {% if job.priority == 'High' %}bg-rose-100 text-rose-700 border-rose-200
                                        {% elif job.priority == 'Medium' %}bg-amber-100 text-amber-700 border-amber-200
                                        {% else %}bg-emerald-100 text-emerald-700 border-emerald-200{% endif %} border">
                                        {{ job.priority }} Priority
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="font-bold text-slate-800 leading-tight">{{ job.client_name }}</div>
                                <div class="text-[10px] text-slate-400 font-medium truncate w-48">{{ job.site_name or
                                    job.address or '-' }}</div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="avatar placeholder">
                                        <div
                                            class="bg-indigo-100 text-indigo-700 rounded-lg w-8 h-8 border border-indigo-200 flex items-center justify-center">
                                            <span class="text-[10px] font-black">{{ job.engineer_contact_name[0] if
                                                job.engineer_contact_name else '?' }}</span>
                                        </div>
                                    </div>
                                    <div class="text-xs font-bold text-slate-600">{{ job.engineer_contact_name }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-sm font-black text-[10px]
                                    {% if job.status == 'In Progress' %}badge-info
                                    {% elif job.status == 'Scheduled' %}badge-warning
                                    {% elif job.status == 'Submitted' %}badge-secondary
                                    {% else %}badge-ghost{% endif %}">
                                    {{ job.status }}
                                </span>
                            </td>
                            <td class="text-right">
                                <div class="flex justify-end gap-2 items-center">
                                    {% if job.wa_link %}
                                    <a href="{{ job.wa_link }}" target="_blank"
                                        class="btn btn-circle btn-ghost btn-xs text-emerald-500 hover:bg-emerald-50 border border-emerald-100"
                                        title="Dispatch via WhatsApp">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor"
                                            viewBox="0 0 448 512">
                                            <path
                                                d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.7 17.8 69.4 27.2 106.2 27.2 122.4 0 222-99.6 222-222 0-59.3-23-115.1-65-157.1zM223.9 445.9c-33.1 0-65.5-8.9-93.7-25.7l-6.7-4-69.6 18.3 18.6-67.9-4.4-7c-18.4-29.3-28.1-63.1-28.1-97.7 0-101.9 82.9-184.8 184.8-184.8 49.4 0 95.8 19.2 130.7 54.1 34.8 34.9 54.1 81.2 54.1 130.7 0 101.9-83 184.8-184.7 184.8zM336.5 311.2c-6.1-3.1-36.4-18-42.1-20.1-5.7-2.1-9.8-3.1-13.9 3.1-4.1 6.1-15.9 20.1-19.5 24.1-3.6 4.1-7.2 4.6-13.3 1.5-6.1-3.1-25.8-9.5-49.1-30.3-18.2-16.2-30.4-36.2-34-42.4-3.6-6.1-.4-9.4 2.7-12.5 2.8-2.7 6.1-7.2 9.2-10.8 3.1-3.1 4.1-5.1 6.1-8.7 2.1-3.6 1-6.7-.5-9.7-1.5-3.1-13.9-33.6-19-46-5-12-10.1-10.4-13.9-10.6-3.6-.2-7.7-.2-11.8-.2-4.1 0-10.8 1.5-16.5 7.7-5.7 6.1-21.6 21.1-21.6 51.5 0 30.4 22.1 59.7 25.2 63.8 3.1 4.1 43.5 66.5 105.4 93.1 14.7 6.3 26.2 10.1 35.1 13 14.8 4.7 28.2 4.1 38.9 2.5 11.9-1.8 36.4-14.9 41.6-29.3 5.2-14.4 5.2-26.7 3.6-29.3-1.5-2.5-5.7-4.1-11.8-7.2z" />
                                        </svg>
                                    </a>
                                    {% endif %}
                                    {% if job.status == 'Submitted' or job.status == 'Completed' %}
                                    <a href="/admin/reports" class="btn btn-success btn-xs text-white"
                                        title="Curate Report">
                                        Curate
                                    </a>
                                    <form hx-post="/admin/jobs/{{ job.job_number }}/archive"
                                        hx-confirm="This will move the job to historical records. Finalize first?"
                                        hx-swap="outerHTML">
                                        <button type="submit"
                                            class="btn btn-ghost btn-xs text-slate-400 hover:text-indigo-600 border border-slate-200">
                                            Done & Archive
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="text-[10px] font-bold text-slate-300 italic">Audit Pending</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-20 text-slate-400 italic">No active jobs in the queue.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Historical Archive -->
        <input type="radio" name="diary_tabs" role="tab" class="tab font-bold" aria-label="Archive & History" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">

            <!-- Search & Filter Archive -->
            <div class="flex flex-col md:flex-row justify-between gap-4">
                <div class="form-control w-full max-w-md">
                    <div class="join">
                        <input type="text" name="q" placeholder="Search by Job # or Client..."
                            class="input input-bordered join-item w-full" hx-get="/admin/jobs/archive/search"
                            hx-trigger="keyup changed delay:500ms" hx-target="#archive-results" />
                        <button class="btn btn-primary join-item">Search</button>
                    </div>
                </div>
                <div class="flex gap-2 text-xs items-center text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Showing final historical records only.
                </div>
            </div>

            <!-- Archive Table -->
            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm w-full shadow-inner bg-slate-50/30 rounded-xl overflow-hidden">
                    <thead class="bg-slate-100 uppercase text-[10px] text-slate-400 font-black">
                        <tr>
                            <th class="p-4">Completion Date</th>
                            <th>Job identity</th>
                            <th>Customer Account</th>
                            <th>Final Status</th>
                            <th class="text-right">Reference</th>
                        </tr>
                    </thead>
                    <tbody id="archive-results">
                        {% for job in jobs if job.status == 'Archived' %}
                        <tr class="opacity-75 hover:opacity-100 transition-opacity">
                            <td class="p-4 font-medium text-slate-500">{{ job.date.strftime('%d %b %Y') }}</td>
                            <td><span class="badge badge-ghost font-mono text-[10px]">{{ job.job_number }}</span></td>
                            <td>
                                <div class="font-bold text-slate-600">{{ job.client_name }}</div>
                                <div class="text-[9px] uppercase tracking-tighter text-slate-400">{{ job.site_name or
                                    'N/A' }}</div>
                            </td>
                            <td><span class="badge badge-outline badge-xs font-bold">{{ job.status }}</span></td>
                            <td class="text-right">
                                <a href="/admin/reports"
                                    class="btn btn-ghost btn-xs text-indigo-500 font-bold underline">View Audit</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-20 text-slate-400 italic">The archive is empty.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}