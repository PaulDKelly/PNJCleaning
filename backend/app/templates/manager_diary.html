{% extends "base.html" %}

{% block title %}Manager Diary - PNJ Extraction Services<!-- Manager Leave Booking Modal -->
<dialog id="manager_leave_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-primary">Book Leave for Staff</h3>
        <p class="py-4 text-sm text-slate-500">Create a leave request on behalf of an engineer.</p>

        <form hx-post="/admin/leave/book" hx-swap="outerHTML" hx-target="#manager-leave-feedback">
            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text font-bold">Engineer</span></label>
                <select name="engineer_name" class="select select-bordered w-full" required>
                    <option value="">Select Engineer</option>
                    {% for eng in engineers %}
                    <option value="{{ eng.contact_name }}">{{ eng.contact_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text font-bold">Reason</span></label>
                <select name="reason" class="select select-bordered w-full">
                    <option value="Holiday">Holiday</option>
                    <option value="Sickness">Sickness</option>
                    <option value="Personal">Personal Emergency</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Start Date</span></label>
                    <input type="date" name="start_date" class="input input-bordered" required />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">End Date</span></label>
                    <input type="date" name="end_date" class="input input-bordered" required />
                </div>
            </div>

            <div id="manager-leave-feedback"></div>

            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Book Leave</button>
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-8 pb-32">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <div class="text-[10px] uppercase tracking-[0.3em] font-bold text-slate-400 mb-1">Operations / Job Queue
            </div>
            <h2 class="text-3xl font-bold text-slate-800 font-outfit">Management Diary</h2>
            <p class="text-slate-500">Coordinate engineer schedules and track job progress.</p>
        </div>
        <div class="flex gap-2">
            <a href="/job-allocation" class="btn btn-primary shadow-lg shadow-primary/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Allocate New Job
            </a>
        </div>
    </div>

    <!-- Tabs Container -->
    <div role="tablist" class="tabs tabs-lifted">

        <!-- Master Calendar -->
        <input type="radio" name="diary_tabs" role="tab" class="tab" aria-label="Calendar" checked />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
            <div id='manager-calendar' class="min-h-[600px] font-sans text-sm"></div>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var calendarEl = document.getElementById('manager-calendar');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,listWeek'
                        },
                        height: 'auto',
                        events: '/api/admin/events',
                        eventDidMount: function (info) {
                            if (info.event.extendedProps.status === 'Pending') {
                                info.el.style.border = '2px dashed #ef4444';
                            }
                        }
                    });
                    calendar.render();
                });
            </script>
        </div>

        <!-- Leave Approvals -->
        <input type="radio" name="diary_tabs" role="tab" class="tab" aria-label="Approvals" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-700">Pending Requests</h3>
                <button onclick="manager_leave_modal.showModal()" class="btn btn-primary btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Book Leave
                </button>
            </div>
            <div id="leave-approval-list" hx-get="/admin/partials/leaves" hx-trigger="load">
                <!-- Loaded via HTMX -->
                <div class="flex justify-center p-8"><span class="loading loading-spinner text-primary"></span></div>
            </div>
        </div>

        <!-- Live Jobs (Legacy List) -->
        <input type="radio" name="diary_tabs" role="tab" class="tab" aria-label="Jobs" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">

            <!-- Controls & Stats -->
            <div class="flex flex-col md:flex-row justify-between gap-6 items-end">
                <div class="stats shadow-sm border border-slate-100 flex-grow md:flex-grow-0">
                    <div class="stat py-2">
                        <div class="stat-title text-[10px] uppercase tracking-widest font-bold text-slate-500">
                            Unfinished Queue (Active)</div>
                        <div class="stat-value text-xl text-primary font-outfit">{{ jobs|selectattr('status', 'ne',
                            'Archived')|list|length }}</div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="form-control w-full max-w-xs">
                    <label class="label py-1">
                        <span class="label-text text-xs font-bold text-slate-500 uppercase">Filter by Engineer
                            View</span>
                    </label>
                    <select name="engineer_name" class="select select-bordered select-sm font-bold text-slate-600"
                        hx-get="/admin/jobs/filter" hx-target="#job-rows" hx-trigger="change">
                        <option value="">Show All Engineers</option>
                        {% for eng in engineers %}
                        <option value="{{ eng.contact_name }}">{{ eng.contact_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Live Table -->
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full shadow-sm rounded-xl overflow-hidden">
                    <thead class="bg-slate-50 uppercase text-[10px] text-slate-500 font-black">
                        <tr>
                            <th class="p-4">Schedule</th>
                            <th>Identity</th>
                            <th>Customer & Site</th>
                            <th>Team</th>
                            <th>Workflow Status</th>
                            <th class="text-right whitespace-nowrap">Admin Actions</th>
                        </tr>
                    </thead>
                    <tbody id="job-rows">
                        {% include "partials/job_rows.html" %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Historical Archive -->
        <input type="radio" name="diary_tabs" role="tab" class="tab" aria-label="Archive" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 space-y-8">

            <!-- Search & Filter Archive -->
            <div class="flex flex-col md:flex-row justify-between gap-4">
                <div class="form-control w-full max-w-md">
                    <div class="join">
                        <input type="text" name="q" placeholder="Search by Job # or Client..."
                            class="input input-bordered join-item w-full" hx-get="/admin/jobs/archive/search"
                            hx-trigger="keyup changed delay:500ms" hx-target="#archive-results" />
                        <button class="btn btn-primary join-item">Search</button>
                    </div>
                </div>
                <div class="flex gap-2 text-xs items-center text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Showing final historical records only.
                </div>
            </div>

            <!-- Archive Table -->
            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm w-full shadow-inner bg-slate-50/30 rounded-xl overflow-hidden">
                    <thead class="bg-slate-100 uppercase text-[10px] text-slate-400 font-black">
                        <tr>
                            <th class="p-4">Completion Date</th>
                            <th>Job identity</th>
                            <th>Customer Account</th>
                            <th>Final Status</th>
                            <th class="text-right">Reference</th>
                        </tr>
                    </thead>
                    <tbody id="archive-results">
                        {% for job in jobs if job.status == 'Archived' %}
                        <tr class="opacity-75 hover:opacity-100 transition-opacity">
                            <td class="p-4 font-medium text-slate-500">{{ job.date.strftime('%d %b %Y') }}</td>
                            <td><span class="badge badge-ghost font-mono text-[10px]">{{ job.job_number }}</span></td>
                            <td>
                                <div class="font-bold text-slate-600">{{ job.client_name }}</div>
                                <div class="text-[9px] uppercase tracking-tighter text-slate-400">{{ job.site_name or
                                    'N/A' }}</div>
                            </td>
                            <td><span class="badge badge-outline badge-xs font-bold">{{ job.status }}</span></td>
                            <td class="text-right">
                                <a href="/admin/reports"
                                    class="btn btn-ghost btn-xs text-indigo-500 font-bold underline">View Audit</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-20 text-slate-400 italic">The archive is empty.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Manager Leave Booking Modal -->
<dialog id="manager_leave_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-primary">Book Leave for Staff</h3>
        <p class="py-4 text-sm text-slate-500">Create a leave request on behalf of an engineer.</p>

        <form hx-post="/admin/leave/book" hx-swap="outerHTML" hx-target="#manager-leave-feedback">
            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text font-bold">Engineer</span></label>
                <select name="engineer_name" class="select select-bordered w-full" required>
                    <option value="">Select Engineer</option>
                    {% for eng in engineers %}
                    <option value="{{ eng.contact_name }}">{{ eng.contact_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control w-full mb-4">
                <label class="label"><span class="label-text font-bold">Reason</span></label>
                <select name="reason" class="select select-bordered w-full">
                    <option value="Holiday">Holiday</option>
                    <option value="Sickness">Sickness</option>
                    <option value="Personal">Personal Emergency</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Start Date</span></label>
                    <input type="date" name="start_date" class="input input-bordered" required />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">End Date</span></label>
                    <input type="date" name="end_date" class="input input-bordered" required />
                </div>
            </div>

            <div id="manager-leave-feedback"></div>

            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Book Leave</button>
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}
