{% extends "base.html" %}

{% block title %}Job Allocation - PNJ Extraction Services{% endblock %}

{% block content %}
<div class="flex flex-col gap-8 max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center space-y-2">
        <h2 class="text-4xl font-extrabold text-slate-800 font-outfit tracking-tight">Job Allocation</h2>
        <p class="text-slate-500 font-medium">Assign engineers to jobs and manage site contacts.</p>
    </div>

    <!-- Allocation Form -->
    <div class="card bg-white shadow-2xl border border-slate-100 overflow-hidden">
        <div class="card-body p-8 lg:p-12">
            <form hx-post="/job-allocation" hx-target="#form-feedback" class="space-y-8">

                <div id="form-feedback" class="min-h-[1rem]"></div>

                <!-- Section 1: Job Identifiers -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Job Number</label>
                        <input type="text" name="job_number" placeholder="e.g. JN1001"
                            class="input input-bordered focus:border-primary" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label font-bold text-slate-600 uppercase text-xs">Date</label>
                            <input type="date" name="date" id="job-date" min="{{ today }}" value="{{ today }}"
                                class="input input-bordered focus:border-primary" required />
                        </div>
                        <div class="form-control">
                            <label class="label font-bold text-slate-600 uppercase text-xs">Time</label>
                            <input type="time" name="time" id="job-time" step="900" list="time-slots"
                                class="input input-bordered focus:border-primary" required />
                            <datalist id="time-slots">
                                <option value="00:00"></option>
                                <option value="00:15"></option>
                                <option value="00:30"></option>
                                <option value="00:45"></option>
                                <option value="01:00"></option>
                                <option value="01:15"></option>
                                <option value="01:30"></option>
                                <option value="01:45"></option>
                                <option value="02:00"></option>
                                <option value="02:15"></option>
                                <option value="02:30"></option>
                                <option value="02:45"></option>
                                <option value="03:00"></option>
                                <option value="03:15"></option>
                                <option value="03:30"></option>
                                <option value="03:45"></option>
                                <option value="04:00"></option>
                                <option value="04:15"></option>
                                <option value="04:30"></option>
                                <option value="04:45"></option>
                                <option value="05:00"></option>
                                <option value="05:15"></option>
                                <option value="05:30"></option>
                                <option value="05:45"></option>
                                <option value="06:00"></option>
                                <option value="06:15"></option>
                                <option value="06:30"></option>
                                <option value="06:45"></option>
                                <option value="07:00"></option>
                                <option value="07:15"></option>
                                <option value="07:30"></option>
                                <option value="07:45"></option>
                                <option value="08:00"></option>
                                <option value="08:15"></option>
                                <option value="08:30"></option>
                                <option value="08:45"></option>
                                <option value="09:00"></option>
                                <option value="09:15"></option>
                                <option value="09:30"></option>
                                <option value="09:45"></option>
                                <option value="10:00"></option>
                                <option value="10:15"></option>
                                <option value="10:30"></option>
                                <option value="10:45"></option>
                                <option value="11:00"></option>
                                <option value="11:15"></option>
                                <option value="11:30"></option>
                                <option value="11:45"></option>
                                <option value="12:00"></option>
                                <option value="12:15"></option>
                                <option value="12:30"></option>
                                <option value="12:45"></option>
                                <option value="13:00"></option>
                                <option value="13:15"></option>
                                <option value="13:30"></option>
                                <option value="13:45"></option>
                                <option value="14:00"></option>
                                <option value="14:15"></option>
                                <option value="14:30"></option>
                                <option value="14:45"></option>
                                <option value="15:00"></option>
                                <option value="15:15"></option>
                                <option value="15:30"></option>
                                <option value="15:45"></option>
                                <option value="16:00"></option>
                                <option value="16:15"></option>
                                <option value="16:30"></option>
                                <option value="16:45"></option>
                                <option value="17:00"></option>
                                <option value="17:15"></option>
                                <option value="17:30"></option>
                                <option value="17:45"></option>
                                <option value="18:00"></option>
                                <option value="18:15"></option>
                                <option value="18:30"></option>
                                <option value="18:45"></option>
                                <option value="19:00"></option>
                                <option value="19:15"></option>
                                <option value="19:30"></option>
                                <option value="19:45"></option>
                                <option value="20:00"></option>
                                <option value="20:15"></option>
                                <option value="20:30"></option>
                                <option value="20:45"></option>
                                <option value="21:00"></option>
                                <option value="21:15"></option>
                                <option value="21:30"></option>
                                <option value="21:45"></option>
                                <option value="22:00"></option>
                                <option value="22:15"></option>
                                <option value="22:30"></option>
                                <option value="22:45"></option>
                                <option value="23:00"></option>
                                <option value="23:15"></option>
                                <option value="23:30"></option>
                                <option value="23:45"></option>
                            </datalist>
                        </div>
                    </div>

                    <script>
                        const dateInput = document.getElementById('job-date');
                        const timeInput = document.getElementById('job-time');
                        const todayStr = "{{ today }}";

                        function updateMinTime() {
                            const now = new Date();
                            const selectedDate = dateInput.value;

                            if (selectedDate === todayStr) {
                                // Round current time UP to the next 15-minute mark for the 'min' constraint
                                let h = now.getHours();
                                let m = Math.ceil(now.getMinutes() / 15) * 15;
                                if (m >= 60) {
                                    m = 0;
                                    h += 1;
                                }
                                const hStr = String(h).padStart(2, '0');
                                const mStr = String(m).padStart(2, '0');
                                timeInput.min = `${hStr}:${mStr}`;
                            } else {
                                timeInput.removeAttribute('min');
                            }
                        }

                        // Force 15-minute rounding on change/blur
                        timeInput.addEventListener('change', function () {
                            if (!this.value) return;
                            const [h, m] = this.value.split(':');
                            const roundedM = Math.round(parseInt(m) / 15) * 15;

                            if (roundedM === 60) {
                                // Round up to next hour
                                let nextH = (parseInt(h) + 1) % 24;
                                this.value = `${String(nextH).padStart(2, '0')}:00`;
                            } else {
                                this.value = `${h}:${String(roundedM).padStart(2, '0')}`;
                            }
                        });

                        dateInput.addEventListener('change', updateMinTime);
                        // Initial check
                        updateMinTime();
                    </script>
                </div>

                <div class="divider text-[10px] uppercase tracking-widest text-slate-400 font-black">Client & Location
                </div>

                <!-- Section 2: Account Mapping -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Service Brand</label>
                        <select name="brand_name" class="select select-bordered focus:border-primary font-medium">
                            <option value="">No Specific Brand</option>
                            {% for b in brands %}
                            <option value="{{ b.brand_name }}">{{ b.brand_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Priority Level</label>
                        <select name="priority" class="select select-bordered focus:border-primary font-medium"
                            required>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Client Account</label>
                        <select name="client_name"
                            class="select select-bordered focus:border-primary font-bold text-indigo-700 bg-indigo-50/20"
                            hx-get="/admin/sites-lookup" hx-target="#site-selector" hx-trigger="change" required>
                            <option value="" disabled selected>Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.client_name }}">{{ client.client_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Specific Site / Venue</label>
                        <select name="site_id" id="site-selector"
                            class="select select-bordered focus:border-primary font-medium">
                            <option value="">Select a client first...</option>
                        </select>
                        <label class="label py-1">
                            <span class="label-text-alt text-slate-400 italic">Lookup automatically updates based on
                                client selection.</span>
                        </label>
                    </div>
                </div>

                <div class="divider text-[10px] uppercase tracking-widest text-slate-400 font-black">Assignment & Notes
                </div>

                <!-- Section 3: Personnel -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Lead Engineer</label>
                        <select name="engineer_name"
                            class="select select-bordered border-primary/30 text-primary font-bold focus:border-primary"
                            required>
                            <option value="" disabled selected>Select Engineer</option>
                            {% for eng in engineers %}
                            <option value="{{ eng.contact_name }}">{{ eng.contact_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label font-bold text-slate-600 uppercase text-xs">Site Contact (Optional)</label>
                        <select name="site_contact_name" class="select select-bordered font-medium">
                            <option value="">None / New Contact</option>
                            {% for contact in site_contacts %}
                            <option value="{{ contact.contact_name }}">{{ contact.contact_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Section 4: Notes -->
                <div class="form-control">
                    <label class="label font-bold text-slate-600 uppercase text-xs">Special Instructions (Report
                        Introduction)</label>
                    <textarea name="notes"
                        placeholder="Enter any specific requirements or site access information... These will appear on the final report if not curated."
                        class="textarea textarea-bordered h-28 focus:border-primary"></textarea>
                </div>

                <div class="card-actions justify-center pt-8">
                    <button type="submit"
                        class="btn btn-primary btn-lg w-full max-w-sm shadow-xl shadow-primary/30 font-bold text-lg">
                        Confirm Allocation
                        <span class="loading loading-spinner htmx-indicator"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}